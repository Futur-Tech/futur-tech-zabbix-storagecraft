<?xml version="1.0" encoding="UTF-8"?>
<zabbix_export>
    <version>5.0</version>
    <date>2021-09-06T15:25:53Z</date>
    <groups>
        <group>
            <name>Templates/Futur-Tech/Applications</name>
        </group>
    </groups>
    <templates>
        <template>
            <template>Template Futur-Tech App StorageCraft</template>
            <name>Template Futur-Tech App StorageCraft</name>
            <description>https://github.com/Futur-Tech/futur-tech-zabbix-storagecraft</description>
            <groups>
                <group>
                    <name>Templates/Futur-Tech/Applications</name>
                </group>
            </groups>
            <applications>
                <application>
                    <name>StorageCraft Dashboard</name>
                </application>
                <application>
                    <name>StorageCraft ImageManager</name>
                </application>
                <application>
                    <name>StorageCraft ShadowProtectSPX</name>
                </application>
            </applications>
            <items>
                <item>
                    <name>ShadowProtectSPX Log</name>
                    <type>ZABBIX_ACTIVE</type>
                    <key>eventlog[Application,,,ShadowProtectSPX,,,skip]</key>
                    <delay>15m</delay>
                    <trends>0</trends>
                    <value_type>LOG</value_type>
                    <applications>
                        <application>
                            <name>StorageCraft ShadowProtectSPX</name>
                        </application>
                    </applications>
                </item>
                <item>
                    <name>ImageManager Log</name>
                    <type>ZABBIX_ACTIVE</type>
                    <key>eventlog[Application,,,StorageCraft ImageManager,,,skip]</key>
                    <delay>15m</delay>
                    <trends>0</trends>
                    <value_type>LOG</value_type>
                    <applications>
                        <application>
                            <name>StorageCraft ImageManager</name>
                        </application>
                    </applications>
                </item>
            </items>
            <discovery_rules>
                <discovery_rule>
                    <name>ImageManager Discovery</name>
                    <type>DEPENDENT</type>
                    <key>storagecraft.imagemanager.discovery</key>
                    <delay>0</delay>
                    <item_prototypes>
                        <item_prototype>
                            <name>{#MACHINE_UPPER} [{#VOL}] Collapse Log</name>
                            <type>ZABBIX_ACTIVE</type>
                            <key>eventlog[Application,&quot;[\s\S]*{#SITECODE}[\s\S]*{#MACHINE}[\s\S]*{#VOL}[\s\S]*&quot;,,StorageCraft ImageManager,,,skip]</key>
                            <delay>15m</delay>
                            <trends>0</trends>
                            <status>DISABLED</status>
                            <discover>NO_DISCOVER</discover>
                            <value_type>LOG</value_type>
                            <applications>
                                <application>
                                    <name>StorageCraft ImageManager</name>
                                </application>
                            </applications>
                        </item_prototype>
                        <item_prototype>
                            <name>{#MACHINE_UPPER} [{#VOL}] Collapse Age</name>
                            <type>CALCULATED</type>
                            <key>imagemanager.collapse.age[{#MACHINE_UPPER},{#VOL}]</key>
                            <delay>15m</delay>
                            <units>uptime</units>
                            <params>now(&quot;wmi.get[root\cimv2,SELECT TimeGenerated FROM Win32_NTLogEvent WHERE (logfile='Application') AND (SourceName='StorageCraft ImageManager') AND (EventCode=1120) AND (Message LIKE '%\\{#SITECODE}%\\{#MACHINE}%\\{#VOL}%.spi')]&#13;
&quot;)-last(&quot;wmi.get[root\cimv2,SELECT TimeGenerated FROM Win32_NTLogEvent WHERE (logfile='Application') AND (SourceName='StorageCraft ImageManager') AND (EventCode=1120) AND (Message LIKE '%\\{#SITECODE}%\\{#MACHINE}%\\{#VOL}%.spi')]&#13;
&quot;)</params>
                            <applications>
                                <application>
                                    <name>StorageCraft Dashboard</name>
                                </application>
                                <application>
                                    <name>StorageCraft ImageManager</name>
                                </application>
                            </applications>
                        </item_prototype>
                        <item_prototype>
                            <name>{#MACHINE_UPPER} [{#VOL}] Collapse Success</name>
                            <type>ZABBIX_ACTIVE</type>
                            <key>wmi.get[root\cimv2,SELECT TimeGenerated FROM Win32_NTLogEvent WHERE (logfile='Application') AND (SourceName='StorageCraft ImageManager') AND (EventCode=1120) AND (Message LIKE '%\\{#SITECODE}%\\{#MACHINE}%\\{#VOL}%.spi')]</key>
                            <delay>15m</delay>
                            <units>unixtime</units>
                            <applications>
                                <application>
                                    <name>StorageCraft ImageManager</name>
                                </application>
                            </applications>
                            <preprocessing>
                                <step>
                                    <type>JAVASCRIPT</type>
                                    <params>var match = /^(\d+)\.\d+-\d+$/gi.exec(value);
var year = match[1].substring(0,4);
var monthIndex = match[1].substring(4,6)-1;
var day = match[1].substring(6,8);
var hours = match[1].substring(8,10);
var minutes = match[1].substring(10,12);
var seconds = match[1].substring(12,14);

var ts = new Date(year, monthIndex, day, hours, minutes, seconds).valueOf() / 1000;
return ts;</params>
                                </step>
                            </preprocessing>
                        </item_prototype>
                    </item_prototypes>
                    <master_item>
                        <key>eventlog[Application,,,StorageCraft ImageManager,,,skip]</key>
                    </master_item>
                    <preprocessing>
                        <step>
                            <type>REGEX</type>
                            <params>^\\\\[^\n\r\\]+(?:.*\\([^\n\r\\]+)\\([^\n\r\\]+)\\ft-backup|.*\\([^\n\r\\]+)\\([^\n\r\\]+))\\([^\n\r\\]*_VOL-b\d+).+\.spi$
\0</params>
                            <error_handler>DISCARD_VALUE</error_handler>
                        </step>
                        <step>
                            <type>JAVASCRIPT</type>
                            <params>var lld = [];
var row = {};
var matches = /^\\\\[^\n\r\\]+(?:.*\\([^\n\r\\]+)\\([^\n\r\\]+)\\ft-backup|.*\\([^\n\r\\]+)\\([^\n\r\\]+))\\([^\n\r\\]*_VOL-b\d+).+\.spi$/gi.exec(value);
if (matches[1]) {
    row[&quot;{#SITECODE}&quot;] = matches[1];
    row[&quot;{#MACHINE}&quot;] = matches[2];
} else {
    row[&quot;{#SITECODE}&quot;] = matches[3];
    row[&quot;{#MACHINE}&quot;] = matches[4];
}
row[&quot;{#MACHINE_UPPER}&quot;] = row[&quot;{#MACHINE}&quot;].toUpperCase();
row[&quot;{#VOL}&quot;] = matches[5];
lld.push(row);
return JSON.stringify(lld);</params>
                        </step>
                    </preprocessing>
                </discovery_rule>
                <discovery_rule>
                    <name>ShadowProtectSPX Discovery</name>
                    <type>DEPENDENT</type>
                    <key>storagecraft.shadowprotectspx.discovery</key>
                    <delay>0</delay>
                    <item_prototypes>
                        <item_prototype>
                            <name>{#MACHINE_UPPER} [{#TASK}] Backup Age</name>
                            <type>CALCULATED</type>
                            <key>shadowprotectspx.backup.age[{#MACHINE_UPPER},{#TASK}]</key>
                            <delay>15m</delay>
                            <units>uptime</units>
                            <params>now(&quot;wmi.get[root\cimv2,SELECT TimeGenerated FROM Win32_NTLogEvent WHERE (logfile='Application') AND (SourceName='ShadowProtectSPX') AND (EventCode=3) AND (Message LIKE '%Backup \&quot;{#TASK}\&quot; on {#MACHINE} successfully finished backing up%')]&quot;)-last(&quot;wmi.get[root\cimv2,SELECT TimeGenerated FROM Win32_NTLogEvent WHERE (logfile='Application') AND (SourceName='ShadowProtectSPX') AND (EventCode=3) AND (Message LIKE '%Backup \&quot;{#TASK}\&quot; on {#MACHINE} successfully finished backing up%')]&quot;)</params>
                            <applications>
                                <application>
                                    <name>StorageCraft Dashboard</name>
                                </application>
                                <application>
                                    <name>StorageCraft ShadowProtectSPX</name>
                                </application>
                            </applications>
                        </item_prototype>
                        <item_prototype>
                            <name>{#MACHINE_UPPER} [{#TASK}] Backup Success</name>
                            <type>ZABBIX_ACTIVE</type>
                            <key>wmi.get[root\cimv2,SELECT TimeGenerated FROM Win32_NTLogEvent WHERE (logfile='Application') AND (SourceName='ShadowProtectSPX') AND (EventCode=3) AND (Message LIKE '%Backup &quot;{#TASK}&quot; on {#MACHINE} successfully finished backing up%')]</key>
                            <delay>15m</delay>
                            <units>unixtime</units>
                            <applications>
                                <application>
                                    <name>StorageCraft ShadowProtectSPX</name>
                                </application>
                            </applications>
                            <preprocessing>
                                <step>
                                    <type>JAVASCRIPT</type>
                                    <params>var match = /^(\d+)\.\d+-\d+$/gi.exec(value);
var year = match[1].substring(0,4);
var monthIndex = match[1].substring(4,6)-1;
var day = match[1].substring(6,8);
var hours = match[1].substring(8,10);
var minutes = match[1].substring(10,12);
var seconds = match[1].substring(12,14);

var ts = new Date(year, monthIndex, day, hours, minutes, seconds).valueOf() / 1000;
return ts;</params>
                                </step>
                            </preprocessing>
                        </item_prototype>
                    </item_prototypes>
                    <master_item>
                        <key>eventlog[Application,,,ShadowProtectSPX,,,skip]</key>
                    </master_item>
                    <preprocessing>
                        <step>
                            <type>REGEX</type>
                            <params>Backup &quot;([^&quot;]+)&quot; on (.+) successfully finished backing up
\0</params>
                        </step>
                        <step>
                            <type>JAVASCRIPT</type>
                            <params>var lld = [];
var row = {};
var matches = /Backup &quot;([^&quot;]+)&quot; on (.+) successfully finished backing up/gi.exec(value);
row[&quot;{#TASK}&quot;] = matches[1];
row[&quot;{#MACHINE}&quot;] = matches[2];
row[&quot;{#MACHINE_UPPER}&quot;] = row[&quot;{#MACHINE}&quot;].toUpperCase();
lld.push(row);
return JSON.stringify(lld);</params>
                        </step>
                    </preprocessing>
                </discovery_rule>
            </discovery_rules>
        </template>
    </templates>
</zabbix_export>
