<?xml version="1.0" encoding="UTF-8"?>
<zabbix_export>
    <version>5.0</version>
    <date>2021-09-07T09:12:07Z</date>
    <groups>
        <group>
            <name>Templates/Futur-Tech/Applications</name>
        </group>
    </groups>
    <templates>
        <template>
            <template>Template Futur-Tech App StorageCraft</template>
            <name>Template Futur-Tech App StorageCraft</name>
            <description>https://github.com/Futur-Tech/futur-tech-zabbix-storagecraft</description>
            <groups>
                <group>
                    <name>Templates/Futur-Tech/Applications</name>
                </group>
            </groups>
            <applications>
                <application>
                    <name>StorageCraft Dashboard</name>
                </application>
                <application>
                    <name>StorageCraft ImageManager</name>
                </application>
                <application>
                    <name>StorageCraft ShadowProtectSPX</name>
                </application>
            </applications>
            <items>
                <item>
                    <name>ShadowProtectSPX Log</name>
                    <type>ZABBIX_ACTIVE</type>
                    <key>eventlog[Application,,,ShadowProtectSPX,,,skip]</key>
                    <delay>15m</delay>
                    <trends>0</trends>
                    <value_type>LOG</value_type>
                    <applications>
                        <application>
                            <name>StorageCraft ShadowProtectSPX</name>
                        </application>
                    </applications>
                    <triggers>
                        <trigger>
                            <expression>{logseverity()}=9</expression>
                            <recovery_mode>NONE</recovery_mode>
                            <name>Critical Error detected in ShadowProtectSPX event log</name>
                            <opdata>{{ITEM.VALUE}.regsub(&quot;(.*)&quot;, \1)}</opdata>
                            <priority>HIGH</priority>
                            <description>This trigger need to be manually closed.</description>
                            <type>MULTIPLE</type>
                            <manual_close>YES</manual_close>
                        </trigger>
                        <trigger>
                            <expression>{logseverity()}=4</expression>
                            <recovery_mode>NONE</recovery_mode>
                            <name>Error detected in ShadowProtectSPX event log</name>
                            <opdata>{{ITEM.VALUE}.regsub(&quot;(.*)&quot;, \1)}</opdata>
                            <priority>AVERAGE</priority>
                            <description>This trigger need to be manually closed.</description>
                            <type>MULTIPLE</type>
                            <manual_close>YES</manual_close>
                        </trigger>
                        <trigger>
                            <expression>{logseverity()}=2</expression>
                            <recovery_mode>NONE</recovery_mode>
                            <name>Warning detected in ShadowProtectSPX event log</name>
                            <opdata>{{ITEM.VALUE}.regsub(&quot;(.*)&quot;, \1)}</opdata>
                            <priority>WARNING</priority>
                            <description>This trigger need to be manually closed.</description>
                            <type>MULTIPLE</type>
                            <manual_close>YES</manual_close>
                        </trigger>
                    </triggers>
                </item>
                <item>
                    <name>ImageManager Log</name>
                    <type>ZABBIX_ACTIVE</type>
                    <key>eventlog[Application,,,StorageCraft ImageManager,,,skip]</key>
                    <delay>15m</delay>
                    <trends>0</trends>
                    <value_type>LOG</value_type>
                    <applications>
                        <application>
                            <name>StorageCraft ImageManager</name>
                        </application>
                    </applications>
                    <triggers>
                        <trigger>
                            <expression>{logseverity()}=9</expression>
                            <recovery_mode>NONE</recovery_mode>
                            <name>Critical Error detected in ImageManager event log</name>
                            <opdata>{{ITEM.VALUE}.regsub(&quot;(.*)&quot;, \1)}</opdata>
                            <priority>HIGH</priority>
                            <description>This trigger need to be manually closed.</description>
                            <type>MULTIPLE</type>
                            <manual_close>YES</manual_close>
                        </trigger>
                        <trigger>
                            <expression>{logseverity()}=4</expression>
                            <recovery_mode>NONE</recovery_mode>
                            <name>Error detected in ImageManager event log</name>
                            <opdata>{{ITEM.VALUE}.regsub(&quot;(.*)&quot;, \1)}</opdata>
                            <priority>AVERAGE</priority>
                            <description>This trigger need to be manually closed.</description>
                            <type>MULTIPLE</type>
                            <manual_close>YES</manual_close>
                        </trigger>
                        <trigger>
                            <expression>{logseverity()}=2</expression>
                            <recovery_mode>NONE</recovery_mode>
                            <name>Warning detected in ImageManager event log</name>
                            <opdata>{{ITEM.VALUE}.regsub(&quot;(.*)&quot;, \1)}</opdata>
                            <priority>WARNING</priority>
                            <description>This trigger need to be manually closed.</description>
                            <type>MULTIPLE</type>
                            <manual_close>YES</manual_close>
                        </trigger>
                    </triggers>
                </item>
            </items>
            <discovery_rules>
                <discovery_rule>
                    <name>ImageManager Discovery</name>
                    <type>DEPENDENT</type>
                    <key>storagecraft.imagemanager.discovery</key>
                    <delay>0</delay>
                    <item_prototypes>
                        <item_prototype>
                            <name>{#MACHINE_UPPER} [{#VOL}] Collapse Log</name>
                            <type>ZABBIX_ACTIVE</type>
                            <key>eventlog[Application,&quot;[\s\S]*{#SITECODE}[\s\S]*{#MACHINE}[\s\S]*{#VOL}[\s\S]*&quot;,,StorageCraft ImageManager,,,skip]</key>
                            <delay>15m</delay>
                            <trends>0</trends>
                            <status>DISABLED</status>
                            <discover>NO_DISCOVER</discover>
                            <value_type>LOG</value_type>
                            <applications>
                                <application>
                                    <name>StorageCraft ImageManager</name>
                                </application>
                            </applications>
                        </item_prototype>
                        <item_prototype>
                            <name>{#MACHINE_UPPER} [{#VOL}] Collapse Age</name>
                            <type>CALCULATED</type>
                            <key>imagemanager.collapse.age[{#MACHINE},{#VOL}]</key>
                            <delay>15m</delay>
                            <units>uptime</units>
                            <params>now(&quot;wmi.get[root\cimv2,SELECT TimeGenerated FROM Win32_NTLogEvent WHERE (logfile='Application') AND (SourceName='StorageCraft ImageManager') AND (EventCode=1120) AND (Message LIKE '%\\{#SITECODE}%\\{#MACHINE}%\\{#VOL}%.spi')]&quot;)-last(&quot;wmi.get[root\cimv2,SELECT TimeGenerated FROM Win32_NTLogEvent WHERE (logfile='Application') AND (SourceName='StorageCraft ImageManager') AND (EventCode=1120) AND (Message LIKE '%\\{#SITECODE}%\\{#MACHINE}%\\{#VOL}%.spi')]&quot;)</params>
                            <applications>
                                <application>
                                    <name>StorageCraft Dashboard</name>
                                </application>
                                <application>
                                    <name>StorageCraft ImageManager</name>
                                </application>
                            </applications>
                            <trigger_prototypes>
                                <trigger_prototype>
                                    <expression>{last()}&gt;129600</expression>
                                    <name>No ImageManager Collapse of {#MACHINE_UPPER} [{#VOL}] for more than 36h</name>
                                    <opdata>Last collapse: {ITEM.LASTVALUE1}</opdata>
                                    <priority>WARNING</priority>
                                </trigger_prototype>
                                <trigger_prototype>
                                    <expression>{last()}&gt;259200</expression>
                                    <name>No ImageManager Collapse of {#MACHINE_UPPER} [{#VOL}] for more than 72h</name>
                                    <opdata>Last collapse: {ITEM.LASTVALUE1}</opdata>
                                    <priority>HIGH</priority>
                                    <dependencies>
                                        <dependency>
                                            <name>No ImageManager Collapse of {#MACHINE_UPPER} [{#VOL}] for more than 36h</name>
                                            <expression>{Template Futur-Tech App StorageCraft:imagemanager.collapse.age[{#MACHINE},{#VOL}].last()}&gt;129600</expression>
                                        </dependency>
                                    </dependencies>
                                </trigger_prototype>
                            </trigger_prototypes>
                        </item_prototype>
                        <item_prototype>
                            <name>{#MACHINE_UPPER} [{#VOL}] Collapse Success</name>
                            <type>ZABBIX_ACTIVE</type>
                            <key>wmi.get[root\cimv2,SELECT TimeGenerated FROM Win32_NTLogEvent WHERE (logfile='Application') AND (SourceName='StorageCraft ImageManager') AND (EventCode=1120) AND (Message LIKE '%\\{#SITECODE}%\\{#MACHINE}%\\{#VOL}%.spi')]</key>
                            <delay>15m</delay>
                            <units>unixtime</units>
                            <applications>
                                <application>
                                    <name>StorageCraft ImageManager</name>
                                </application>
                            </applications>
                            <preprocessing>
                                <step>
                                    <type>JAVASCRIPT</type>
                                    <params>var match = /^(\d+)\.\d+-\d+$/gi.exec(value);
var ts = new Date();

ts.setUTCFullYear(match[1].substring(0,4));
ts.setUTCMonth(match[1].substring(4,6)-1);
ts.setUTCDate(match[1].substring(6,8));
ts.setUTCHours(match[1].substring(8,10));
ts.setUTCMinutes(match[1].substring(10,12));
ts.setUTCSeconds(match[1].substring(12,14));
ts.setUTCMilliseconds(0);

return ts.valueOf() / 1000;</params>
                                </step>
                                <step>
                                    <type>DISCARD_UNCHANGED_HEARTBEAT</type>
                                    <params>1d</params>
                                </step>
                            </preprocessing>
                        </item_prototype>
                    </item_prototypes>
                    <master_item>
                        <key>eventlog[Application,,,StorageCraft ImageManager,,,skip]</key>
                    </master_item>
                    <preprocessing>
                        <step>
                            <type>REGEX</type>
                            <params>^\\\\[^\n\r\\]+(?:.*\\([^\n\r\\]+)\\([^\n\r\\]+)\\ft-backup|.*\\([^\n\r\\]+)\\([^\n\r\\]+))\\([^\n\r\\]*_VOL-b\d+).+\.spi$
\0</params>
                            <error_handler>DISCARD_VALUE</error_handler>
                        </step>
                        <step>
                            <type>JAVASCRIPT</type>
                            <params>var lld = [];
var row = {};
var matches = /^\\\\[^\n\r\\]+(?:.*\\([^\n\r\\]+)\\([^\n\r\\]+)\\ft-backup|.*\\([^\n\r\\]+)\\([^\n\r\\]+))\\([^\n\r\\]*_VOL-b\d+).+\.spi$/gi.exec(value);
if (matches[1]) {
    row[&quot;{#SITECODE}&quot;] = matches[1];
    row[&quot;{#MACHINE}&quot;] = matches[2];
} else {
    row[&quot;{#SITECODE}&quot;] = matches[3];
    row[&quot;{#MACHINE}&quot;] = matches[4];
}
row[&quot;{#MACHINE_UPPER}&quot;] = row[&quot;{#MACHINE}&quot;].toUpperCase();
row[&quot;{#VOL}&quot;] = matches[5];
lld.push(row);
return JSON.stringify(lld);</params>
                        </step>
                    </preprocessing>
                </discovery_rule>
                <discovery_rule>
                    <name>ShadowProtectSPX Discovery</name>
                    <type>DEPENDENT</type>
                    <key>storagecraft.shadowprotectspx.discovery</key>
                    <delay>0</delay>
                    <item_prototypes>
                        <item_prototype>
                            <name>{#MACHINE_UPPER} [{#TASK}] Backup Age</name>
                            <type>CALCULATED</type>
                            <key>shadowprotectspx.backup.age[{#MACHINE_UPPER},{#TASK}]</key>
                            <delay>15m</delay>
                            <units>uptime</units>
                            <params>now(&quot;wmi.get[root\cimv2,SELECT TimeGenerated FROM Win32_NTLogEvent WHERE (logfile='Application') AND (SourceName='ShadowProtectSPX') AND (EventCode=3) AND (Message LIKE '%Backup \&quot;{#TASK}\&quot; on {#MACHINE} successfully finished backing up%')]&quot;)-last(&quot;wmi.get[root\cimv2,SELECT TimeGenerated FROM Win32_NTLogEvent WHERE (logfile='Application') AND (SourceName='ShadowProtectSPX') AND (EventCode=3) AND (Message LIKE '%Backup \&quot;{#TASK}\&quot; on {#MACHINE} successfully finished backing up%')]&quot;)</params>
                            <applications>
                                <application>
                                    <name>StorageCraft Dashboard</name>
                                </application>
                                <application>
                                    <name>StorageCraft ShadowProtectSPX</name>
                                </application>
                            </applications>
                        </item_prototype>
                        <item_prototype>
                            <name>{#MACHINE_UPPER} [{#TASK}] Backup Success</name>
                            <type>ZABBIX_ACTIVE</type>
                            <key>wmi.get[root\cimv2,SELECT TimeGenerated FROM Win32_NTLogEvent WHERE (logfile='Application') AND (SourceName='ShadowProtectSPX') AND (EventCode=3) AND (Message LIKE '%Backup &quot;{#TASK}&quot; on {#MACHINE} successfully finished backing up%')]</key>
                            <delay>15m</delay>
                            <units>unixtime</units>
                            <applications>
                                <application>
                                    <name>StorageCraft ShadowProtectSPX</name>
                                </application>
                            </applications>
                            <preprocessing>
                                <step>
                                    <type>JAVASCRIPT</type>
                                    <params>var match = /^(\d+)\.\d+-\d+$/gi.exec(value);
var ts = new Date();

ts.setUTCFullYear(match[1].substring(0,4));
ts.setUTCMonth(match[1].substring(4,6)-1);
ts.setUTCDate(match[1].substring(6,8));
ts.setUTCHours(match[1].substring(8,10));
ts.setUTCMinutes(match[1].substring(10,12));
ts.setUTCSeconds(match[1].substring(12,14));
ts.setUTCMilliseconds(0);

return ts.valueOf() / 1000;</params>
                                </step>
                                <step>
                                    <type>DISCARD_UNCHANGED_HEARTBEAT</type>
                                    <params>1d</params>
                                </step>
                            </preprocessing>
                        </item_prototype>
                    </item_prototypes>
                    <master_item>
                        <key>eventlog[Application,,,ShadowProtectSPX,,,skip]</key>
                    </master_item>
                    <preprocessing>
                        <step>
                            <type>REGEX</type>
                            <params>Backup &quot;([^&quot;]+)&quot; on (.+) successfully finished backing up
\0</params>
                        </step>
                        <step>
                            <type>JAVASCRIPT</type>
                            <params>var lld = [];
var row = {};
var matches = /Backup &quot;([^&quot;]+)&quot; on (.+) successfully finished backing up/gi.exec(value);
row[&quot;{#TASK}&quot;] = matches[1];
row[&quot;{#MACHINE}&quot;] = matches[2];
row[&quot;{#MACHINE_UPPER}&quot;] = row[&quot;{#MACHINE}&quot;].toUpperCase();
lld.push(row);
return JSON.stringify(lld);</params>
                        </step>
                    </preprocessing>
                </discovery_rule>
            </discovery_rules>
        </template>
    </templates>
</zabbix_export>
